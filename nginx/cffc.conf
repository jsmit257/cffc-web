worker_processes  1;

events {
    worker_connections  1024;
}

http {
  include            mime.types;
  default_type       application/octet-stream;
  sendfile           on;
  keepalive_timeout  65;

  types_hash_bucket_size 64;
  types_hash_max_size    4096;

  gzip               on;
  gzip_http_version  1.1;
  gzip_vary          on;
  gzip_comp_level    6;
  gzip_proxied       any;
  gzip_types         text/plain text/html text/css application/json application/javascript application/x-javascript text/javascript;
  gzip_buffers       16 8k; 
  gzip_disable       "MSIE [1-6]\.(?!.*SV1)";

  client_max_body_size 10M;
  
  server {
    charset      utf-8;
    listen       80;
    # server_name  $HOSTNAME

    rewrite ^/(.*)$ https://$SSL_HOST:$SSL_PORT/$1 permanent; # change to server_name when it's settled
  }

  server {
    charset      utf-8;
    # server_name  $HOSTNAME
    listen       443 ssl;
    root         /www;

    ssl_certificate            cert.pem;
    ssl_certificate_key        key.pem;
    ssl_session_cache          shared:SSL:1m;
    ssl_session_timeout        5m;
    ssl_ciphers                HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers  on;

    location /album {
        root      /;
        autoindex on;
    }

    location ~ /(user|address|contact|auth|valid|logout|otp|validateotp) {
        proxy_pass   http://${AUTHN_HOST}:${AUTHN_PORT};
    }

    # not so fond of this arrangement
    location ~ ^/(eventtype|generation|ingredient|lifecycle|note|photo|report|stage|strain|substrate|ts|vendor|undel) {
        proxy_pass   http://${CFFC_API_HOST}:${CFFC_API_PORT};
    }
 }
}
